language: node_js
node_js:
  - 8
cache: yarn
env:
  global:
    - NODE_ENV=test
script:
  - yarn run lint
  - yarn run test -- --coverage
  - NODE_ENV=production $(yarn bin)/webpack
after_success:
  - bash yarn.sh
  - bash <(curl -s https://codecov.io/bash)
deploy:
  provider: s3
  region: us-east-1
  bucket: $(node config ProjectFQDomain)
  acl: public_read
  cache_control: "max-age=31536000"
  local_dir: dist
  skip_cleanup: true
  on:
    branch:
      - master
    condition: $(node aws/utils bucketExists) = "true"
after_deploy:
  - node aws/utils invalidate "/index.html"
  # This package is broken with Yarn
  - node_modules/sentry-cli-binary/bin/sentry-cli releases -o $(node config SentryOrg) -p $(node config SentryProject) new $TRAVIS_COMMIT
  - node_modules/sentry-cli-binary/bin/sentry-cli releases -o $(node config SentryOrg) -p $(node config SentryProject) files $TRAVIS_COMMIT upload-sourcemaps dist
notifications:
  email: false
  slack: bjacobel:xasDl3nTxo2feJGba70E43oR
